---
layout: post
title: 八卦某 G 公司开发方式及流程
---

>他山之石，可以攻玉。

话说本人从毕业到现在一直在某 B 公司，所以很好奇其它公司内部是如何工作的，曾经浏览过某 Y 公司内部的 Twiki，也拜访过某 F 公司了解他们高效的开发流程，但对某 G 公司了解不多，只零零碎碎知道一些东东，这里抽空梳理了一下之前了解到的各种东西，希望能给大家提供些参考。

注意：以下内容主要信息来自网上收集、『In The Plex』这本书及某位匿名同事的介绍，纯粹为了技术交流和讨论，本人从未在某 G 工作过，不受 NDA 限制，但所有信息无法确认真伪，加上信息不足，所以这里所看到的结论肯定很片面，欢迎提供更多内幕。

## 分工

首先，某 G 大部分产品线都不区分前端工程师和后端工程师，一个人需要用从前到后都负责开发，不过似乎这几年有些变化，有专门的 [Front End](https://www.google.com/about/careers/search/#t=sq&q=j&d=Front+End&li=10&j=Front+End&) 职位了，但应该是很少数产品线的做法，具体情况未知。

N 年前有人去 G 面试过，按照他的说法，某 G 要求应聘者必须至少要会 C++ 和 Java 中的一种，只会 Python 是不够的，要是只懂 JS 那还是算了。这个信息其实很关键，能用来解释一些内部现象，后面我会再次提到。

我个人认为前端工程师确实应该了解基本的后端知识，在某 B 公司以前很多前端工程师只负责模板开发，这导致一个很严重的问题，那就是前端工程师往往不知道如何搭建环境，开发时需要依赖后端工程师提供数据，这也是为什么我们的 FIS 还内嵌了本地服务来方便调试。

另外国内有公司还对前端工程师做进一步细分，按照职能分为写 HTML/CSS 和 JS 的，我个人并不赞同这种做法，因为 HTML 和 JS 是密切相关的，这样分工将不利于代码管理与优化，尤其是交互复杂的页面，因为 JS 很依赖 HTML，拆分反而增加沟通成本。

## 代码管理

* 内部所有人都能看到代码
    * 09 年时某 office 不是这样[1]，但后续未知
    * 如果要提交需要相关人员 review
    * 使得 G 内部工程师可以很方便地切换项目，很少一个人只负责一个项目
* 代码只有最新版(trunk)，没有 release 版本
    * 如果要修改原有的接口，必须通知所有使用方，不过因为所有人都能看到所有代码，所以很容易了解到底有谁使用
    * 所以一般大家喜欢新增接口
* 有个代码的搜索引擎
    * 估计和下线的 Code Search 比较像（好像还是某高管写的，具体忘记哪看到的了，待查）
    * 如果想使用某个基础库，最好的方法莫过于直接搜索使用到这个库的代码
        * 我认为这种方式比让工程师写文档靠谱多了，你可以对外宣称自己的库有多少多少种用法，多么多么 NB，但其实真正用起来大家就只用来做少数几种事情，绝大部分调用这个库的代码都是相识的，所以直接给出例子能让别人更容易上手。 
* 代码依赖是通过全局的方式统一部署的
    * 可以理解为类似 npm 的东东，不过这是支持多语言的
    * 我个人觉得应该很类似 Chromium 中的 [GYP](https://code.google.com/p/gyp/)
    * 之前在 G 工作过的 iOS 工程师也在[某篇被删的文章](https://news.ycombinator.com/item?id=5001830)中透露版本库种不放 Xcode 项目文件，而是每次由工具生成出来。
    * 这种依赖管理方式让人想起某 A 公司（不是卖水果那个，是卖商品的）内部完善的 SOA 机制，只不过 A 是通过服务的方式对外暴露，而 G 喜欢代码级别的重用
* 很少使用第三方库
    * 如果要是用只能选用内部维护的版本，一般周期会很长（一个月）。
* 代码管理软件是 Perforce
    * 某 G 直接将这个公司收购了，这些员工为 G 内部打造了一套开发流程
    * 另外我挖到了一篇 [Perforce 的性能优化的论文](http://research.google.com/pubs/archive/39983.pdf)，这里面透露了很多 G 公司内部的管理情况（发表时间是 2011 年 5 月），以下两点取自这篇论文：
        * 这个程序用了 17 年，有 2 千万次 changelist（类似这个 https://codereview.chromium.org/）
        * 文档及相关数据文件也放上面

整体来说某 G 的代码管理方式我是非常喜欢的，这种开放共享的互联网精神，能最大程度地发挥开发人员的主动性与协作意识，创造出更大的价值。

### feature flag

因为没有分支，所以代码只有一份，要实验新功能就通过 flag 来控制的，这个 flag 由线上 Borg 系统来管理，能做到针对某一部分的 Cookie 开启不同的 feature。

这个 flag 开关功能在某 F 也有，通过它可以很方便地功能的发布。

由于是主干开发，所以如果某个功能最终不上线，那需要手工删掉，对于架构调整的代码要回溯起来就很麻烦了。

### 严格检查代码

据说某 G 工程师大部分时间在写单元测试，整个开发过程更类似传统的瀑布风格。

单元测试可以保证接口的质量，但对于页面就没办法了，虽然可以通过 selenium 的方式写用例，但 G 内部大家都不愿意写，个人认为这个问题确实无解，页面随便一改就导致大量测试失效，我还没见任何一家公司解决（某 F 只保证登录等基本功能），目前看来唯一可行的就是自动页面截图 diff。

不过和国内不一样的是，国外对浏览器兼容性问题不怎么关注了，因为现代浏览器中的兼容性问题比以前好得多，这点和某 F 公司一样，只支持高版本的 IE。

因为只有主干，所以提交代码很谨慎，需要经过 3 步

* 代码风格检查
    * 应该主要参考[这个文档](https://code.google.com/p/google-styleguide/)
    * 非常严格，据说还会检查命名什么的
    * 有段子说 Python 作者 Guido van Rossum 写的 Python 代码无法通过检查，所以一直没提交。。。当然这是假的，仅供娱乐，因为他老人家写的 [rietveld](https://code.google.com/p/rietveld) 还是挺符合某 G 规范的
* 单元测试检测
* 代码 owner 的 Review

因为一旦出错可能会导致影响其它人的工作（因为每个人都依赖主干啊），没准会遭到其它国家 office 工程师的直接指责，所以大家对于代码提交都非常谨慎，再三确认，压力山大。

在代码风格和 code review 的执行上，某 G 做得很彻底，这点值得学习。

## 前端如何开发

除了 Gmail、Maps、Plus 这样的特例，基本上都是后端生成页面，很少项目使用 JS 来生成界面，内部很少使用 MVC 框架，这点其实在很多公司都差不多，某 B 也是一样的，除了地图及广告管家等应用，其它页面基本上都是通过「模板」生成的。

与很多公司不太一样的是，某 G 的页面是通常是由 Java 或 C++ 语言所写的模版引擎生成的，而且还开源出来了，分别是 [Closure Templates](https://developers.google.com/closure/templates/) 和 [CTemplate](https://code.google.com/p/ctemplate/)，而其它公司大多喜欢用 php，比如某 B 的贴吧和某 F。

对某 G 来说，「前端」工程师要写 Java 和 JavaScript，而「后端」服务主要是 C++（某些地方开始使用 Go 了）.

前面说到招人时都要会 Java 了，这带来的结果是团队成员大多数更了解 Java 而不是 JavaScript，在这种背景下诞生了 GWT，它在内部很多地方使用，按照某人的说法，主要的考虑是：

* 能自动生成跨浏览器浏览器代码
* 结构规范，通过编译器就能提前发现很多问题

对于专业做前端的同学，看到 GWT 多半不会喜欢，感觉太麻烦了，但如果是 Java 出身的工程师其实是很容易接受和理解的，尤其是对于习惯了 Java 的代码组织方式及强类型语言的人，反而会很不习惯 JavaScript 这种弱类型的语言，觉得太难控制太容易出错了，比如拿到一个变量，在 Java 中通过它的类型就能知道它的数据结构，但 JavaScript 就不行了，只能 `console.dir` 出来或找相关实现的代码。

话说 G 曾经弄过一个 Wave 的产品，后来产品没做成就将代码[开源出来了](http://incubator.apache.org/wave/source-code.html)，我认为这个代码能反应出 G 内部在使用 GWT 时的开发风格，我用 cloc 统计了一下它的代码情况，结果如下：

    ----------------------------------------------------------
    Language        files       blank      comment        code
    ----------------------------------------------------------
    Java             2329       50121       139226      245856
    Python             34        1308         2537        4451
    CSS                57         617         1670        2791
    XML               148        1009         2627        2487
    Ant                15         131          335         987
    HTML                8         124          155         831
    Bourne Shell        9          61          190         185
    Javascript          1          12           26          56

神奇吧，这么复杂的前端交互应用，只有 1 个 56 行的 JS 文件，而且其实我看了这个 JS 还是没必要的，所以你可以理解为什么 G 只招懂 Java 或 C++ 的工程师了吧。

某 G 后来又推出了 Dart，在我看来就是取代 GWT 的，前面说到的两个 GWT 的优点在 Dart 都有，而且在 I/O 2012 有一个演讲题目是 [Migrating Code from GWT to Dart
](https://www.youtube.com/watch?v=EvACKPBo_R8)

不过，内部也不是所有人都喜欢 GWT，比如 Plus 就没使用，而是[直接基于 Closure 开发](http://www.infoq.com/news/2011/07/Google-Plus)，并使用 Closure template。

我的观点是：对于我所处的团队及用户类产品来说，GWT 没有意义，而 Dart 虽然比起 GWT 好得多，但由于目前和 JS 交互上[实在太麻烦](https://www.dartlang.org/articles/js-dart-interop/)，使得它的使用场景很有限，除非是一个功能很明确的内部工具，否则与 JS 的交互是无法避免的，因此我个人更喜欢 [TypeScript](http://www.typescriptlang.org/) 这种增强形方案，因为它可以逐步适应，既能有类型支持的优势，又能直接使用现有代码。

## 内部工作流程

以下是打听到的某个产品项目开发流程：

* PM 或工程师提出某个想法，UX 做原型 mock
* PM 申请项目审核（通过率不高）、工程师开发 UX 无关部分
* 工程师完成开发
* 线上小流量实验
* PM/工程师分析实验结果，完成报告，申请全量上线（通过率不高）
    * 通过数据来证明这个功能是有价值的
    * 需要解释这些数据的变化原因
* 分批逐步上线，这个过程中还会有很多审核
* 最终确定是否要上线（通过率不高）

一般整个项目周期很长（至少一季度），项目最终上线时间点无法确定，大部分的项目最终都无法正式上线。

另一个特点是完全靠数据说话，以前某个视觉设计师在离开 G 后就在博客上[吐槽这点](http://stopdesign.com/archive/2009/03/20/goodbye-google.html)，它认为这样无法进行大胆的界面改版。

这个流程和我们搜索产品以前的开发流程很类似（2010 年），对于成熟的搜索引擎来说这么做确实有它的道理，毕竟随便改个什么都很可能影响收入，因此是要十分谨慎的，但这种开发方式并不适合面向用户类的产品，如社区、游戏等，因为开发周期实在太长了。

## 内部工具

2008 年前的内部工具情况可以通过[这篇文章](http://blogoscoped.com/archive/2008-03-12-n39.html)和[这个 PPT](http://www.slideshare.net/guestcc91d4/googles-internal-systems) 了解，不过之后就不清楚了（估计变化不大？），看起来很多外部工具都有内部版本(Docs、Mail、Talk、Calendar 等）。

这里说一下 Chromium 项目中看到的几个地方，据说很多产品都有内部版：

* 网站是基于 [Sites](https://sites.google.com) 搭建的
* 设计文档喜欢使用 Doc，因为可以在线编辑和评论功能，所以多人协作会很方便
* https://codereview.chromium.org/
* 在 [Groups](http://groups.google.com/a/chromium.org/group/chromium-discuss) 中进行讨论
* 使用 [code](https://code.google.com/p/chromium/issues/) 来管理 issues
* [Buildbots](https://chromium-build.appspot.com/p/chromium/console) 来进行编译和集成测试
* 搭建了各种检测工具来保证质量，具体细节推荐[读这本书](http://www.amazon.com/Google-Tests-Software-James-Whittaker/dp/0321803027)，总体来说没什么神奇的地方，完全是靠细致的工作

## 小节

以下是我认为可以借鉴的地方：

* 源码不分版本，对内部所有人公开
    * FEX 内部已经是这样了，不过我们应该推动更广泛的开放
* 严格的代码规范及单元测试机制
    * FEX 所有项目将接入 Travis CI
    * 代码规范及单元测试的强制检查
    * 代码 owner review 机制
* 通过实际例子来使用，甚至不用看文档
    * 加强对 demo 及 example 的要求，不能是简单的 hello，而应该从产品线实际使用案例中抽取出来
* 文档及相关资料和代码放一起
    * 这能保证找起来很方便
    * 如果由于种种原因不能放一起，至少也要放链接
* GWT 的静态检查机制
    * 整理这篇文章后让我重新思考了静态类型的优点，后续计划尝试 TypeScript

## 参考资料

* [1]: 『In The Plex』
